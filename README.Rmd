---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Explorando caracteristicas do modelo linear generalizado

O objetivo deste projeto é treinar a aplicação de modelos de regressão linear e criar gráficos de dispersão que apresentem paramêtros relacionados a qualidade do modelo. Para isso, será replicada algumas análises realizadas pelo Ladislas Nalborczyk em seu texto "Using R to make sense of the generalised linear model"

Para criação das figuras e modelos foi utilizada a base de dados Howell1 do pacote Rethinking (McElreath, 2016), que contém dados sobre 544 indivíduos, incluindo altura (centímetros), peso (quilogramas), idade (anos) e sexo (0 indicando feminino e 1 indicando masculino).
```{r Carregando pacotes, message=FALSE}
# Lendo os pacotes --------------------------------------------------------

library(rethinking)
library(ggplot2)
library(ggExtra)

```
Após filtrar a base de dados apenas com os dados pertencentes aos indíviduos com idade igual ou maior que 18 anos (>=18), foi criado um gráfico de dispersão utilizando o ggplot2 (i.e., geom_point e geom_smooth). Um objeto foi criado com o gráfico (p). Em seguida, foi utilizada a função ggMarginal do pacote ggExtra para criar um gráfico de dispersão com os histogramas em cada um dos eixos.
```{r Lendo e filtrando a base}
# Abrindo, criando um elemento (d) e visualizando a base ------------------

data("Howell1")

# Filtrando a idade (>18yr) -----------------------------------------------

d <- Howell1 |>
  dplyr::filter(age >= 18)
```
```{r Grafico, fig.align='center', message=FALSE}
# Criando um grafico de dispersão -----------------------------------------

p <- d |>
  ggplot(mapping = aes(x = weight, y = height)) +
  geom_point(pch = 21, color = "white", fill = "black", size = 2, alpha = 0.8) +
  geom_smooth(method = "lm", color = "black", se = TRUE)+
  theme_bw(base_size = 12)


# Usando ggExtra para fazer grafico de dispersão com histograma -----------

ggMarginal(p, type = "histogram")

```

Uma rápida inspeção visual do conjunto de dados revela uma relação positiva entre altura e peso. A linha da regressão traçada no grafico acima corresponde ao seguinte modelo linear assumindo uma distribuição normal:

**Peso ~ Normal (µi, σ)**

**µi = α + β ∙ 43**

que pode ser excrita com a sintaxe: 

lm(formula, data, subset, weights, na.action,
   method = "qr", model = TRUE, x = FALSE, y = FALSE, qr = TRUE,
   singular.ok = TRUE, contrasts = NULL, offset, ...)
   
Assim, o código para esta análise e o resultado serão:
```{r}
mod1 <- lm(height ~ weight, data = d)

mod1

```
O intercept (i.e., 113.879) representa a altura prevista quando o peso está em 0 (o que não faz muito sentido neste caso), enquanto o slope (i.e., 0.905) representa a mudança na altura quando o peso aumenta em uma unidade (e.g., um quilograma). 

# Fazendo predições e ajustes no modelo 

A principal vantagem de um modelo de regressão é a possibilidade de fazer previsões como, por exemplo, baseado no modelo apresentado acima, qual é a altura esperada para um indivíduo com 43 kg. No R isto é realizado criando um geom_point e marcando a linha referente ao peso que você quer fazer a predição da estatura e usando a função predict, que é igual a α + β * 43.

Vamos testar!

```{r, fig.align='center'}
# Fazendo gráfico com linhas referentes ao peso que queremos preve --------
wght <- 43

d |> 
  ggplot(mapping = aes(x = weight, y = height)) +
  geom_line(mapping = aes(y = predict(mod1)), size = 1) +
  geom_point(size = 2, alpha = .2) +
  geom_segment(
    x = wght, xend = wght,
    y = 0,
    yend = predict(mod1, newdata = data.frame(weight = wght)),
    linetype = 2, lwd = 0.5) +
  geom_segment(
    x = 0, xend = wght,
    y = predict(mod1, newdata = data.frame(weight = wght)),
    yend = predict(mod1, newdata = data.frame(weight = wght) ),
    linetype = 2, lwd = 0.5
  ) +
  theme_bw(base_size = 12)
```
Conforme o autor do texto ensina, implementar a função predict manualmente é fácil. Vamos testar para ver como funciona.

```{r}
# Aplicando a função predict ----------------------------------------------

d <- d |> 
  dplyr::mutate(
    pred_mod1 = predict(mod1),
    pred_mod1_2 = coef(mod1)[1] + coef(mod1)[2] * weight
  )

head(d)
```
Como dá para perceber, a função predict está simplesmente recuperando parâmetros do modelo ajustado (neste caso, pelo intercept e slope) para fazer previsões sobre a variável de resultado, dados alguns valores do (s) preditor (es). Este modelo ajustado corresponde à segunda linha do código descrito acima (i.e.,pred_mod1_2). 

# Fazendo predições para desfechos binários

É vbem comum querer predizer desfechos binários (e.g., sim e não, tem e não tem). E o modelo mais adequado para fazer isso é por meio de modelos de regressão logística.

Para realizar uma regressão logística no R utiliza-se a função **glm**, onde o argumento **family** é usado para especificar a probabilidade do modelo e a função de ligação. Para isso, utiliza-se a função glm cuja sintaxe é:

glm(formula, family = gaussian, data, weights, subset,
    na.action, start = NULL, etastart, mustart, offset,
    control = list(...), model = TRUE, method = "glm.fit",
    x = FALSE, y = TRUE, singular.ok = TRUE, contrasts = NULL, ...)

Para testar a função glm, segue abaixo o código sendo aplicado na base de dados que estamos usando para predizer o sexo pela estatura e o resultado.
```{r}
mod2 <-
  glm(male ~ height,
      data = d,
      family = binomial(link = "logit"))
mod2 <-
  glm(male ~ height,
      data = d,
      family = binomial(link = "logit"))


# Aplicado o modelo para predizer o sexo pela estatura usando a predict----
# e fitted ----------------------------------------------------------------

d <- 
  d |> 
  dplyr::mutate(
    pred_mod2 = predict(mod2),
    fitted_mod2 = fitted(mod2)
  )

# Selecionando e vendo o resultado ----------------------------------------

d |> 
  dplyr::select(height, weight, male, pred_mod2, fitted_mod2) |> 
  head()
```
Conforme o autor destaca, diferente do modelo linear utilizado para variável continuas, neste modelo o predic e o fitted apresentou resultados bastante diferentes. O autor explica que a saída das funções predict e fitted são diferentes quando usamos um GLM porque a função predict retorna previsões do modelo na escala do preditor linear (neste exempo, na escala log-odds), enquanto a função fitted retorna previsões na escala da resposta. 
De maneira generosa, o autor disponibiliza uma função criada por ele (logit_dotplot.R) para realizar um gráfico para uma regressão logística. Abaixo, segue a chamada da função mais a aplicação dela nesta base de dados.
```{r message=FALSE, fig.align='center'}
source("logit_dotplot.R")
logit_dotplot(d$height, d$male, xlab = "height", ylab = "p(male)")
```
# Verificando erros e residuos com a função rediduals












